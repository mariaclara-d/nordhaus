{% extends 'base.html' %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <!-- Coluna de Estatísticas -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Estatísticas do Estoque</h5>
                </div>
                <div class="card-body">
                    <!-- Exibir o total de itens -->
                    <p>Total de Itens: <strong>{{ total_itens }}</strong></p>
                    <!-- Exibir itens abaixo do mínimo -->
                    <p>Itens Abaixo do Mínimo: <strong>{{ itens_abaixo_minimo }}</strong></p>
                    <!-- Exibir itens para repor -->
                    <p>Itens para Repor: <strong>{{ itens_para_repor }}</strong></p>
                </div>
            </div>
        </div>

        <!-- Coluna de Ações Rápidas -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Ações Rápidas</h5>
                </div>
                <div class="card-body">
                    <!-- Botão para adicionar item -->
                    <a href="{{ url_for('dashboard.adicionar_item') }}" class="btn btn-primary w-100 mb-2">Adicionar Item</a>
                    <!-- Botão para ver o estoque -->
                    <a href="{{ url_for('dashboard.estoque') }}" class="btn btn-secondary w-100 mb-2">Ver Estoque</a>
                </div>
            </div>
        </div>

        <!-- Coluna de Notificações -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Notificações</h5>
                </div>
                <div class="card-body">
                    <!-- Verifica se há itens abaixo do mínimo -->
                    {% if itens_abaixo_minimo > 0 %}
                        <div class="alert alert-danger">
                            <strong>Atenção!</strong> {{ itens_abaixo_minimo }} itens estão abaixo do estoque mínimo.
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <strong>Tudo certo!</strong> Nenhum item está abaixo do estoque mínimo.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Upload e Processamento de Tabelas -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Upload de Tabela de Insumos</h5>
                </div>
                <div class="card-body">
                    <!-- Formulário de Upload -->
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="file">Selecione uma imagem da tabela:</label>
                            <input type="file" class="form-control-file" name="file" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Enviar</button>
                    </form>

                    <!-- Área para exibir os dados processados -->
                    <div id="result" class="mt-4">
                        <h6>Dados Processados:</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Mínimo</th>
                                    <th>Contagem</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody">
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para processar o upload via AJAX -->
<script>
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.querySelector('input[type="file"]').files[0]);

        try {
            const response = await fetch('/dashboard/upload_tabela', {
                                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // Limpar a tabela antes de adicionar novos dados
            const tableBody = document.getElementById('resultTableBody');
            tableBody.innerHTML = '';

            // Preencher a tabela com os dados processados
            result.dados.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.codigo}</td>
                    <td>${item.nome}</td>
                    <td>${item.minimo}</td>
                    <td>${item.contagem}</td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Erro ao processar o upload:', error);
            alert('Erro ao processar o upload. Tente novamente.');
        }
    });
</script>

{% endblock %}